<apex:page id="TopBox_Individual_Response_FeedbackTask" standardController="Task" extensions="TopBoxWG.TopBox_TaskPageExtension" showHeader="false" sidebar="false" >

    <apex:slds />


    <apex:outputPanel layout="block" rendered="{!ISNULL(feedback)}">
        <div class="slds-box slds-theme_error slds-text-color_inverse">
            <h1>A Feedback record was not found on the Task</h1>
        </div>
    </apex:outputPanel>

    <apex:outputPanel layout="block" rendered="{!NOT(ISNULL(feedback))}">
        <div>
            <div role="dialog" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <div class="slds-modal__header slds-modal__header_empty"> </div>
                    <div class="slds-modal__content slds-p-around_medium slds-text-align_center" >
                        <p class="slds-m-vertical_medium">
                            Please disable your popup blocker or click the button below to open TopBox
                        </p>
                        <div id="Button">

                            <a id="TheButton" href="https://clients.topboxtech.com/?{!feedback.TopBoxWG__TopBox_Individual_Response__c}&SessionId={!$Api.Session_ID}&InstanceUrl={!$Api.Partner_Server_URL_360}&UserId={!$User.Id}"
                               target="_blank"
                               class="slds-button slds-button_brand"
                               onclick="backToRecord();"
                            >Continue to TopBox</a>

                        </div>
                    </div>
                </div>
            </div>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </div>



        <script>
            let uri = document.getElementById('TheButton').getAttribute('href');
            console.log(uri);
            let newWin = window.open(uri, "_blank");

            if(!newWin || newWin.closed || typeof newWin.closed=='undefined')
            {
                console.log('blocked');
            }else{
                backToRecord();
            }

            function backToRecord () {
                window.location = '/{!Task.Id}';
            }

        </script>
    </apex:outputPanel>

</apex:page>