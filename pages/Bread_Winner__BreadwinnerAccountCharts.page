<apex:page standardController="Account" extensions="Bread_Winner.BreadwinnerAccountChartsExtension" action="{!initializeAccountAndRelatedInvoice}" sidebar="false" showHeader="false">
  <html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" lang="en">    
  <head>
      <apex:slds />
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <script src="{!URLFOR($Resource.Breadwinner_Xero, 'Breadwinner_Xero/JS/jquery-1.11.3.js')}"></script>
      <style>
    
    #chartDivId ul{list-style-type: none;}
    #chartDivId li{display: inline-block; list-style-type: none; }
    .content{padding:15px 15px 15px 30px; margin-left:20px; border-left:2px solid #666; }
    .labelHeading{font-size:20px; display:block; margin-bottom:10px;}
    .orgStatus{ padding:0px; display:block;}
    
    #invoiceInfoTable{width:200px;}
    .rightText{ text-align:right;}
    .leftText{ text-align:left;}
    .trialTxt{font-size: 12px; text-align:center; }
    #invoiceInfoTable td{padding:5px; background: #f1f1f1;border-bottom: 1px solid #fff;}
    .gaugeChartText{font-size: 11px;width: 200px; margin-top:-10px;}
    .schedmsg .messageText{
      display:none;         
    }
    .headerCustomStyling{
      background-color: rgb(243, 242, 242);
      font-weight: 700 !important;
    }
    .downloadInvoiceStatus .slds-spinner_container{
      position: fixed;top: 0%; z-index: 9999;
    }    
    #piechart_3d div[dir*='ltr']{height: 150px !important;;}
    .pieChart3dTitle{font-size: 11px;font-weight: bold;}
    @media screen and (max-width: 550px) {
       #chartDivId > tbody > tr,  #chartDivId > tbody, #chartDivId{display:block;}
       #chartDivId > tbody > tr > td{display:block;}
       #piechart_3d,  #chart_div{width:142px; margin:0 auto;}
       #bar_chart_div{width: 393px;margin: 0 auto;}
       .trialTxt{text-align: center; font-size: 12px; position: relative;}
       .gaugeChart{ text-align:center;}
       .invoiceTable{padding:22px 15px;}
       .barChart{padding-bottom:20px;}
       #invoiceInfoTable{width:100%;}
       .gaugeChartText{font-size: 11px;margin-top:0;width:auto;}
    }
    .message .messageText a {
      margin: 0px;
    }
    img[src*="https://s3.amazonaws.com/"]{
        max-height: 22px;
    }
    .tableResponsiveStyling th, .tableResponsiveStyling td{
      padding: 0.25rem !important;
    }
    .tableResponsiveStyling{
      table-layout: fixed;
    }
    .tableResponsiveStyling th:nth-child(3), .tableResponsiveStyling td:nth-child(3){
        width: 16% !important;        
    }
    .tableResponsiveStyling th:nth-child(1), .tableResponsiveStyling td:nth-child(1), .tableResponsiveStyling th:nth-child(5), .tableResponsiveStyling td:nth-child(5), .tableResponsiveStyling th:nth-child(6), .tableResponsiveStyling td:nth-child(6),.tableResponsiveStyling th:nth-child(7), .tableResponsiveStyling td:nth-child(7), .tableResponsiveStyling th:nth-child(8), .tableResponsiveStyling td:nth-child(8){
        width: 10% !important;        
    }
    .tableResponsiveStyling th:last-child, .tableResponsiveStyling td:last-child{
        width: 75px !important;
    }
    .tableResponsiveStyling th:nth-child(4), .tableResponsiveStyling td:nth-child(4), .tableResponsiveStyling th:nth-child(2), .tableResponsiveStyling td:nth-child(2), {
        width: 12% !important;
    }    
    </style>

    <apex:includeScript value="{!URLFOR($Resource.Bread_Winner__Breadwinner_Xero, 'Breadwinner_Xero/JS/BW_Account_Charts.js')}" />

    <script type="text/javascript">
    var j$ = jQuery.noConflict();
    function HideStyleSheet() {
        j$("link.user[href$='elements.css']").each(function() {
            j$(this).removeAttr("href");
        });
    }
    function message() {
        j$(".infoM6, .infoM4, .infoM3, .infoM2, .infoS1").addClass("slds-notify slds-notify_alert slds-theme_inverse-text  slds-text-align_left slds-text-heading_small slds-m-bottom_small").css( {"font-weight":"500","line-height":"1.4","word-spacing":"1px","justify-content":"left"} );
        j$(".errorM6, .errorM4, .errorM3, .errorM2, .errorS1").addClass("slds-notify slds-notify_alert slds-theme_error  slds-text-align_left slds-text-heading_small slds-m-bottom_small").css({"font-weight":"500","line-height":"1.4","word-spacing":"1px","justify-content":"left"});
        j$(".warningM6, .warningM4, .warningM3, .warningM2, .warningS1").addClass("slds-notify slds-notify_alert slds-theme_warning  slds-text-align_left slds-text-heading_small slds-m-bottom_small").css( {"font-weight":"500","line-height":"1.4","word-spacing":"1px","justify-content":"left"}) ;
        j$(".confirmM6, .confirmM4, .confirmM3, .confirmM2, .confirmS1").addClass("slds-notify slds-notify_alert slds-theme_success slds-text-align_left slds-text-heading_small slds-m-bottom_small").css( {"font-weight":"500","line-height":"1.4","word-spacing":"1px","justify-content":"left"} ) ;
        
        j$("div .messageText h4").css( "color", "white" );
        j$("div[class*='warning'] div.messageText h4").css( "color", "black" );
        j$("table.messageTable td").css({"color" : "white"});
        j$("div[class*='warning'] table.messageTable td").css( "color", "black" );
    }
    function addallfuncs(){
        HideStyleSheet();
        message();
    }
    j$(function(){
        addallfuncs();
    });
    function renderDownloadSVG(){        
        var imageURL = '{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#download')}';
        var SVG = j$('<svg/>', {
            class: 'slds-button__icon',
        });        
        var SVGUse = j$('<use/>');
        SVGUse.attr('xlink:href',imageURL);
        j$('.downloadIcon').prepend(SVG.append(SVGUse));
        j$('.downloadIcon' ).html(j$('.downloadIcon').html());        
    }
   </script>
   <script> 
      google.load("visualization", "1", {packages:["corechart", "gauge", "bar"]});
      google.setOnLoadCallback(drawChart);
      
      function drawChart() {
                      
            var jsonDataTotalInvoicesBilled = {!SUBSTITUTE(JSENCODE(jsonTotalBilledPieChartData), '\\', '')};
            var pie_chart_data = new google.visualization.DataTable(jsonDataTotalInvoicesBilled);
            
            var pie_chart_options = {              
              width: 200,
              height: 200,             
              is3D: true,
              colors: ['green', 'orange', 'red'],              
              legend: { position: 'none' },
              chartArea:{top:13}
            };
           
            var gaugeData = {!JSENCODE(longestOverDueGaugeChartData)};
            var guage_data = google.visualization.arrayToDataTable([
              ['Label', 'Value'],
              ['Days', gaugeData],
            ]);

            var guage_options = {
              width: 130, height: 130,
              max: 90,
              redFrom: 30, redTo: 90,
              yellowFrom:0, yellowTo: 30,
              majorTicks: [0,30,60,90],
              minorTicks: 5,
              chartArea:{top:50}
            };
            
            var barChartData = {!SUBSTITUTE(JSENCODE(barChartData), '\\', '') };
            console.log(barChartData);
            
            var bar_chart_data = new google.visualization.DataTable(barChartData);
            
            var bar_chart_options = {
                width:450,
                height:190,
                legend: { position: 'bottom' },
                bar: { groupWidth: '50%' },
                isStacked: true,
                colors: ['green','orange', '#dc3912','#B0C4DE'],
                chartArea:{righ:0,top:20}
              };

              if({!IF(noBarChartData,true,false)}){
                bar_chart_options.vAxis= {minValue : 1000};
              }
              
        var pie_chart = new google.visualization.PieChart(document.getElementById('piechart_3d'));
        pie_chart.draw(pie_chart_data, pie_chart_options); 
       
        var guage_chart = new google.visualization.Gauge(document.getElementById('chart_div'));
        guage_chart.draw(guage_data, guage_options);
        
        var bar_chart = new google.visualization.ColumnChart(document.getElementById('bar_chart_div'));
        bar_chart.draw(bar_chart_data, bar_chart_options);
        
      }
      window.onresize = drawChart;
    </script>

  </head>
  <body>
    <apex:form style="padding-top:4px" id="accountChartForm">
      <div class="downloadInvoiceStatus">
        <apex:actionStatus id="assign-action-status" layout="block" onstop="saveToPC();" >
          <apex:facet name="start" >
              <div class="slds-spinner_container">
                  <div class="slds-spinner_brand slds-spinner slds-spinner_medium" role="alert">
                      <span class="slds-assistive-text">Loading</span>
                      <div class="slds-spinner__dot-a"></div>
                      <div class="slds-spinner__dot-b"></div>
                  </div>
              </div>
          </apex:facet>
        </apex:actionStatus>  
      </div>
      <apex:outputPanel id="invoiceContentPanel">        
          <a id="downloadInvoiceContentAnchorTag" download="{!JSENCODE(invoiceName)}.pdf" style="display: none;" ></a>
      </apex:outputPanel>       
    <apex:actionFunction name="deleteMDfield" action="{!deleteMasterDetailFieldIfExists}" rerender="nothing" />
    <apex:outputPanel rendered="{!isMasterDetailFieldExist}" style="font-size: 20px;">
      <apex:pageMessage rendered="{!isBreadwinnerAdministrator}" severity="WARNING" escape="false" summary="Please delete a legacy field to ensure Breadwinner will function smoothly. You can {!linkForMDDeletionArticle}."/>
      <apex:pageMessage rendered="{!NOT(isBreadwinnerAdministrator)}" severity="WARNING" escape="false" summary="Please ask your Salesforce Admin to delete a legacy field. They can {!linkForMDDeletionArticle}."/>
    </apex:outputPanel>
    <apex:outputPanel rendered="{!daysOverdue>0}">
      <apex:outputPanel rendered="{!OR(isBreadwinnerAdministrator, daysOverdue > 7)}">
        <apex:pageMessage severity="{!daysOverdueSeverity}" summary="{!summaryMessage}" strength="{!IF(daysOverdue > 10, 3, IF(daysOverdue >3, 2, 1))}" />
      </apex:outputPanel>
    </apex:outputPanel>
    <apex:outputPanel layout="block" style="background:#FFFFCC; font-weight: 500; line-height: 1.4; word-spacing: 1px; text-align: center; font-size: 20px; margin-top:30px;" rendered="{!isListHasNoRows}" >
      Not intialized properly.
    </apex:outputPanel>    
     <apex:outputPanel rendered="{!isBreadwinnerAdministrator}" styleClass="schedmsg" >
          <apex:outputPanel rendered="{!NOT(areScheduledJobsRunbyActiveUser)}" style="font-size:14px;" >
              <apex:pageMessage severity="WARNING" >
                  <table>
                      <td><apex:image styleClass="crossIcon"  value="{!URLFOR($Resource.Bread_Winner__Breadwinner_Xero, 'Breadwinner_Xero/Images/yellow_check.png')}"/></td>
                      <td style="vertical-align: middle;"> Breadwinner scheduled Jobs are running from an Inactive User. Visit the&nbsp;<a target="_blank" href="{!URLFOR($Page.TroubleshootingPage)}">Troubleshooting page</a> to fix this.</td>
                  </table>
              </apex:pageMessage>
          </apex:outputPanel>
      </apex:outputPanel>
    <apex:outputPanel layout="block" style="text-align:center;background:#FFFFCC; layout:block; line-height:18px};">
        <apex:outputPanel rendered="{!AND(isOrgOutOfSync,!isFreePlan)}">
          <apex:outputPanel style="font-size:12px;" >
            Please reset your connection to Xero <apex:outputText value="{!outOfSyncOrg}"/> by clicking "Please reconnect to Xero" from the <a href="{!URLFOR($Page.Breadwinner)}" target="_blank" >Breadwinner tab</a>.<br/>
          </apex:outputPanel>
        </apex:outputPanel>
        <apex:outputPanel rendered="{!AND(NOT(isOrgOutOfSync),len(messageifAccountSyncisNotCompleted) > 0)}">
          <apex:outputText style="font-size:12px" escape="false" value="{!messageifAccountSyncisNotCompleted}"/><br/>
        </apex:outputPanel>
        <apex:outputPanel rendered="{!AND(NOT(isOrgOutOfSync),len(messageifAccountSyncisNotCompleted) == 0)}">
          <apex:outputPanel rendered="{!AND(nodOfDaysLeft > -61, NOT(ISBLANK(expirationText)) )}" styleClass="trialTxt" >
              {!expirationText}
              <apex:outputPanel rendered="{!AND(NOT(isSandbox),NOT(isDeveloperEdition))}"> Please contact your Account Executive.
              </apex:outputPanel>              
          </apex:outputPanel>
          <!-- This article has been removed as everyone are using Public app.
		  <apex:outputPanel rendered="{!AND(ISBLANK(expirationText),NOT(ISBLANK(alertMessage)))}" style="font-size:14px; line-height:22px;">
              <apex:outputPanel style="font-size:20px; font-weight:bold">
                Upgrade Breadwinner to access&nbsp;<apex:outputLink value="{!BW_SupportPortalURL}/customer/portal/articles/2149998-configure-default-revenue-account-and-due-date-fields" target="_blank">new features</apex:outputLink>!
                <br/>
              </apex:outputPanel>
              {!alertMessage}
          </apex:outputPanel> -->
        </apex:outputPanel>
    </apex:outputPanel>
    <apex:pageMessage summary="Insufficient Access" severity="WARNING" strength="3" rendered="{!NOT(AccountChartsareAccessible) && NOT(isFreePlan)}">
        &nbsp;&nbsp;&nbsp;You do not have sufficient access to Read Invoices,&nbsp;<apex:outputLink styleClass="link" target="_blank" value="/{!Permissionsetid}">{!if(isAdministrator, 'Please assign Permission set.', 'Please contact your administrator.')}</apex:outputLink>
    </apex:pagemessage>
    <apex:pageMessages escape="false" id="pgmsgs"/>
    <apex:outputPanel rendered="{!AND(!isFreePlan, isInvoicePresent, AccountChartsareAccessible)}">
        <table id="chartDivId" cellpadding="0" cellspacing="0" border="0" width="100%">
            
            <tr>
            <!--<td class="trialTxt">
                
                <apex:outputpanel rendered="{!IF(nodOfDaysLeft >0, true, false )}" styleClass="trialTxt1">
                    Your trial expires in {!nodOfDaysLeft} days.                          
                </apex:outputpanel>
            </td>-->
            <!-- <td class="pieChart3d">
                <div id="piechart_3d"></div>
            </td>
            <td class="gaugeChart">
                <p class="gaugeChartText">
                <apex:outputLabel value="{!longestOverDueGaugeChartTitle}"></apex:outputLabel>
                </p>
                <div id="chart_div"></div>-->
                <td class="pieChart3d">
               <div style="text-align:center;text-align: -webkit-center;text-align: -moz-center;">
                <apex:outputPanel styleClass="pieChart3dTitle">
                    Total Billed:<apex:outputText value="{0, number, ##,##0.00}">
                                <apex:param value="{!totalBilledAmount}" />
                      </apex:outputText> <apex:outputLabel value="{!IF(isMultiCurrency==true, 'in Multiple Currencies',''+CurrencyCode)}"/>
                  </apex:outputPanel>
                    
                   <div id="piechart_3d"></div>
               </div>
           </td>
           <td class="gaugeChart" >
               <div style="text-align:center;text-align: -webkit-center;text-align: -moz-center;margin-right: 20%;">
              
                   <p class="gaugeChartText">
                      {!longestOverDueGaugeChartTitle}
                      <apex:outputPanel rendered="{!!noOverdueInvoices}">
                          <apex:outputText value="{0, number, ##,##0.00}">
                                  <apex:param value="{!maxOverdueAmount}" />
                          </apex:outputText> and is the longest overdue at 
                          <apex:outputText value="{0, number, ##,##0}">
                                  <apex:param value="{!noOfOverdueDays}" />
                          </apex:outputText> Days 
                      </apex:outputPanel>
                   </p>
                   
                <div id="chart_div"></div>
               </div>
            </td>
            <td class="invoiceTable">
                <table id="invoiceInfoTable" cellpadding="0" cellspacing="0" border="0" width="100%">
                    <tr>
                        <td>
                            <apex:outputText value="{0, number,##,##0}">
                                <apex:param value="{!invoiceInfo.noOfOverdueInvoice}" />
                            </apex:outputText>
                        </td>
                        <td>
                            Invoices Overdue:
                        </td>
                        <td class="rightText">
                            <apex:outputText value="{0, number,##,##0.00}">
                                <apex:param value="{!invoiceInfo.amountOverdue}" />
                            </apex:outputText>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <apex:outputText value="{0, number,##,##0}">
                                <apex:param value="{!invoiceInfo.noOfDueInvoice}" />
                            </apex:outputText>
                        </td>
                        <td> 
                            Invoices Due:
                        </td>
                        <td class="rightText">
                            <apex:outputText value="{0, number,##,##0.00}">
                                <apex:param value="{!invoiceInfo.amountDue}" />
                            </apex:outputText>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <apex:outputText value="{0, number,##,##0}">
                                <apex:param value="{!invoiceInfo.noOfFullyPaidInvoice}" />
                            </apex:outputText>                            
                        </td>
                        <td>
                            Invoices Fully Paid:
                        </td>
                        <td class="rightText">
                            <apex:outputText value="{0, number,##,##0.00}">
                                <apex:param value="{!invoiceInfo.amountFullyPaid}" />
                            </apex:outputText>                                                             
                        </td>
                    </tr>
                </table>
                <div>
                  <apex:outputLabel style="{!IF(isMultiCurrency,'','padding-left:25%;')}" value="{!IF(isMultiCurrency==true, 'Amounts are in Multiple Currencies','Amounts in '+CurrencyCode)}"/>
                </div>
            </td>
            <td class="barChart">
                <div id="bar_chart_div"></div>
            </td>
            </tr>
        </table>
    </apex:outputPanel>
    <apex:outputpanel rendered="{!AND(!isInvoicePresent, !isFreePlan)}">
      <div style="font-size: 20px;margin-bottom: 10px;text-align: center;padding-top: 20px;">
        {!noInvoiceMessageHeading}
      </div>
      <div style="font-size: 13px;margin-bottom: 10px;text-align: center;">
        {!noInvoiceMessageSubHeading}
      </div>    
    </apex:outputpanel>
    
    <apex:outputPanel layout="block" style="text-align:center;" rendered="{!isFreePlan}" id="freePlanBlock"> 
      <apex:commandButton value="Show 3 Most Recent Invoices by Invoice Date" styleClass="slds-button slds-button_brand slds-m-bottom_medium slds-m-top_small" action="{!recentMostInvoices}" rendered="{!NOT(AND(recentMostInvoicesList.size!=null, recentMostInvoicesList.size>0))}" reRender="pgmsgs, freePlanBlock" status="assign-action-status" oncomplete="renderDownloadSVG();message();HideStyleSheet();"></apex:commandButton>      
      <apex:outputPanel layout="block" id="mostRecentInvoices" rendered="{!$ObjectType.Bread_Winner__Invoice__c.Accessible}">
        <apex:dataTable value="{!recentMostInvoicesList}" var="inv" rows="3" styleclass=" tableResponsiveStyling slds-m-top_small slds-table slds-no-row-hover slds-table_bordered slds-table_col-bordered slds-border_right slds-border_left" width="100" rendered="{!AND(recentMostInvoicesList.size!=null, recentMostInvoicesList.size>0)}">
            <apex:column headerValue="Invoice" headerClass="headerCustomStyling slds-truncate  " styleClass="slds-truncate " value="{!inv.Name}" width="10"/>
            
            <apex:column headerValue="Status" headerClass="headerCustomStyling slds-truncate " title="{!IF(inv.Status=='AUTHORISED',IF(AND (inv.AmountDue != null, inv.AmountDue>0, inv.Due_Date  <  TODAY() ),'OVERDUE','DUE'),IF(inv.Status=='SUBMITTED','Submitted for Approval',inv.Status))}" styleClass="slds-truncate " rendered="{!$ObjectType.Bread_Winner__Invoice__c.fields.Bread_Winner__Status__c.Accessible}" width="13">
              <apex:image value="{!IF(OR(inv.Status == 'VOIDED', inv.Status == 'DELETED'),
              "https://s3.amazonaws.com/bw-cdn/x-ltng.png",
              IF(
              OR(inv.Status == 'DRAFT', inv.Status == 'SUBMITTED'),
              "https://s3.amazonaws.com/bw-cdn/pencil.png",
              IF(AND(inv.Due_Date != null, inv.AmountDue!= null, inv.AmountDue > 0,inv.Due_Date  <  TODAY()),
              "https://s3.amazonaws.com/bw-cdn/red-flag.png" ,
              IF(AND(inv.Due_Date != null, inv.AmountDue!= null, inv.AmountDue > 0, NOT(inv.Due_Date  <  TODAY()) ),
              "https://s3.amazonaws.com/bw-cdn/yellow-flag.png" ,              
              "https://s3.amazonaws.com/bw-cdn/green-flag.png"
              ))))}"/>&nbsp;
              <apex:outputText value="{!IF(inv.Status=='AUTHORISED',IF(AND (inv.AmountDue != null, inv.AmountDue>0, inv.Due_Date  <  TODAY() ),'OVERDUE','DUE'),IF(inv.Status=='SUBMITTED','Submitted for Approval',inv.Status))}"/>
            </apex:column>                              
            <apex:column headerValue="Xero Contact" title="{!inv.CompanyName}" headerClass="headerCustomStyling slds-truncate " styleClass="slds-truncate" value="{!inv.CompanyName}" width="15" />          
            <apex:column headerValue="Invoice Date" value="{!inv.DateString}" title="{!inv.DateString}" headerClass="headerCustomStyling slds-truncate" styleClass="slds-truncate" rendered="{!$ObjectType.Bread_Winner__Invoice__c.fields.Bread_Winner__Invoice_Date__c.Accessible}" width="12" />
            <apex:column headerValue="Due Date" value="{!inv.DueDateString}" title="{!inv.DueDateString}" headerClass="headerCustomStyling slds-truncate " styleClass="slds-truncate" rendered="{!$ObjectType.Bread_Winner__Invoice__c.fields.Bread_Winner__Due_Date__c.Accessible}" width="12" />
            <apex:column headerValue="Paid" title="{!inv.AmountPaid}" styleClass="slds-text-align_right slds-truncate" headerClass="slds-text-align_right   headerCustomStyling" rendered="{!$ObjectType.Bread_Winner__Invoice__c.fields.Bread_Winner__Amount_Paid__c.Accessible}" width="10">
              <apex:outputText value="{0, number,##,##0.00}">
                  <apex:param value="{!inv.AmountPaid}" /> 
              </apex:outputText>
            </apex:column>            
            <apex:column headerValue="Due" title="{!inv.AmountDue}" styleClass="slds-text-align_right slds-truncate  " headerClass="slds-text-align_right   headerCustomStyling" rendered="{!$ObjectType.Bread_Winner__Invoice__c.fields.Bread_Winner__Amount_Due__c.Accessible}" width="10">
              <apex:outputText value="{0, number,##,##0.00}">
                  <apex:param value="{!inv.AmountDue}" /> 
              </apex:outputText>
            </apex:column>            
            <apex:column headerValue="Total" title="{!inv.Total}" styleClass="slds-text-align_right slds-truncate " headerClass="slds-text-align_right   headerCustomStyling" rendered="{!$ObjectType.Bread_Winner__Invoice__c.fields.Bread_Winner__Total__c.Accessible}" width="10">
              <apex:outputText value="{0, number,##,##0.00}">
                  <apex:param value="{!inv.Total}" /> 
              </apex:outputText>
            </apex:column>
            <apex:column headerValue="Download" headerClass="headerCustomStyling slds-truncate " styleClass="slds-text-align_center" width="15px" >
              <apex:commandLink styleclass="slds-icon_container slds-icon-utility-download" onclick="DownloadInvoice('{!inv.externalId}','{!inv.Name}');" reRender="freePlanBlock">
                <span class="downloadIcon">
                  <svg class="slds-button__icon">
                      <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Asset.SLDS, 'assets/icons/utility-sprite/svg/symbols.svg#download')}" />
                  </svg>
              </span>  
              </apex:commandLink>              
            </apex:column>            
        </apex:dataTable>
        <apex:outputpanel rendered="{!AND(!isInvoicePresent, !unAuthorized)}">
          <div style="font-size: 20px; margin-bottom: 10px; text-align: center;">
            {!noInvoiceMessageHeadingInFree}
          </div>         
        </apex:outputpanel>
        <apex:actionFunction name="DownloadInvoiceactionfunction" action="{!downloadInvoicePDF}" status="assign-action-status" reRender="invoiceContentPanel,refreshpanel" oncomplete="renderDownloadSVG();">
          <apex:param assignTo="{!invoiceXeroID}" value="" name="firstparam" />
          <apex:param assignTo="{!invoiceName}" value="" name="secondparam" />
        </apex:actionFunction>
      </apex:outputPanel>      
    </apex:outputPanel>
  </apex:form>
  </body>
  <script type="text/javascript">  
    try{
      if({!isUnauthorizedEndpoint}===true){
        var binding = new XMLHttpRequest();
        var host = "{!LEFT($Api.Enterprise_Server_URL_350, FIND('/services',$Api.Enterprise_Server_URL_350))}";
        var request = 
            '<?xml version="1.0" encoding="UTF-8"?><env:Envelope xmlns:env="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><env:Header><SessionHeader xmlns="http://soap.sforce.com/2006/04/metadata"><sessionId>{!$Api.Session_ID}</sessionId></SessionHeader></env:Header><env:Body><upsertMetadata xmlns="http://soap.sforce.com/2006/04/metadata"><metadata xsi:type="RemoteSiteSetting"><fullName>Breadwinner_Xero_MyServer</fullName><description>Required to use Metadata API, created by Breadwinner</description><disableProtocolSecurity>false</disableProtocolSecurity><isActive>true</isActive><url>{!remoteSiteURL}</url></metadata></upsertMetadata></env:Body></env:Envelope>';
        
        binding.open('POST', host+'services/Soap/m/35.0');
        binding.setRequestHeader('SOAPAction','""');
        binding.setRequestHeader('Content-Type', 'text/xml');
        binding.onreadystatechange =
            function() {
            if(this.readyState==4) {
                var parser = new DOMParser();
                var doc  = parser.parseFromString(this.response, 'application/xml');
                var errors = doc.getElementsByTagName('errors');
                console.log(errors);
            }
        }
        binding.send(request);
        deleteMDfield();
      }
    }
    catch(error){
      console.log(error);
    }
    function DownloadInvoice(invoiceXeroID, invName){       
      DownloadInvoiceactionfunction(invoiceXeroID, invName);
    }
      
  </script>
  <apex:outputPanel id="refreshpanel">    
    <apex:outputPanel rendered="{!refreshPage}">
        <script>
        function saveToPC(){
          console.log('save to PC');
            try{
                var url = "data:application/pdf;content-disposition:attachment;headers=filename%3D{!JSENCODE(invoiceXeroID)}.pdf;base64,{!JSENCODE(base64Value)}";
                var nAgt = navigator.userAgent;
                var verOffset;
                var isClassic = false;
                var isFirefox = false;
                
                var link = document.getElementById('downloadInvoiceContentAnchorTag');
                var canDownload = true;
                if ((verOffset=nAgt.indexOf("Firefox"))!=-1) {
                    isFirefox = true;
                    var windowURL = decodeURIComponent(window.location.href);
                    isClassic = (windowURL.includes(".com/servlet/"));
                    if(isClassic  || "{! $User.UIThemeDisplayed == 'Theme3'}"=="true"){
                        canDownload = true;
                    }
                    else{
                        canDownload = false;
                    }
                }
                if(canDownload){
                    link.href = "data:application/pdf;content-disposition:attachment;content-length:{!LEN(JSENCODE(base64Value))};base64,{!JSENCODE(base64Value)}";
                    link.target = '_top';
                    link.click();
                }
                else{
                    window.open(url,'_blank');
                }
            }catch(e){
                Console.log('Exception while saving Invoice to PC :::'+e);
            }
        }
        </script>
    </apex:outputPanel>
  </apex:outputPanel>
  </html>
</apex:page>