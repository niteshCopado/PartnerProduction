/**
* This Test Class requires the seeAllData annotation and existing Knowledge Base Articles to succeed.
* The reason for this is: The API for pusblishin an article does a DML plus a callout.
* We would need a DML to create an article, plus multiple callouts to HelpDocs.
* This would break the test with "Uncommited work pending..."
*/
//(seeAllData=true)
@isTest
public class TestHelpDocs {
    
    @TestSetup static void setupData() {
        Knowledge__kav k = TestDataFactory.createKnowledgeArticle( 'TestArticleURLName','Test Article Title Here','Test Knowledge Article Body Content Here');
        Insert k;
        Knowledge__kav k2 = TestDataFactory.createKnowledgeArticle( 'ArticleURLName','No Snapshot records found.','Test Knowledge');
        Insert k2;
    }
    static testMethod void testSync() {
        List<Knowledge__kav> KnowledgeList = new List<Knowledge__kav>([SELECT Id, Body__c, Title, HelpDocs_Id__c, KnowledgeArticleId FROM Knowledge__kav WHERE IsVisibleInPkb = true AND URLName = 'TestArticleURLName' limit 1]);
        for(Knowledge__kav this_kav : KnowledgeList) {
            this_kav.IsVisibleInPkb=false;
        }
        update KnowledgeList;
        User knowledgeUser = [SELECT Id, Username FROM User where UserPermissionsKnowledgeUser=true and isActive=true limit 1];
        system.runAs(knowledgeUser){
            testHttpCalloutMock request1 = new testHttpCalloutMock(200, 'OK', '{"articles":[{"article_id":"83612pr768","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"No Snapshot records found.","description":"When trying to commit in a user story, you might see the warning below after clicking on the Commit Files button.There are 2 reason why this warning can be displayed even though you know the Git Snap…","short_version":"When trying to commit in a user story, you might see the warning below after clicking on the Commit Files button.There are 2 reason why this warning can be displayed even though you know the Git Snap…","body":"","slug":"no-snapshot-records-could-be-found-to-create-your-file-commit","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-10T10:20:03.507Z","updated_at":"2018-05-10T10:20:03.507Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/no-snapshot-records-could-be-found-to-create-your-file-commit","relative_url":"/knowledge-base/no-snapshot-records-could-be-found-to-create-your-file-commit","description_was_autogenerated":false,"short_version_was_autogenerated":false},{"article_id":"gd9qfe18h6","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"Unable to use OAuth when validating Org Credential.","description":"\\nWhen creating an Org Credential, even when valid credentials are used, sometimes Copado doesn\'t validate the OAuth athentication.This could happen i\\n\\n\\n\\nWhen creating an Org Credential, even when val…","short_version":"\\nWhen creating an Org Credential, even when valid credentials are used, sometimes Copado doesn\'t validate the OAuth athentication.This could happen i\\n\\n\\n\\nWhen creating an Org Credential, even when val…","body":"","slug":"unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-09T09:34:41.647Z","updated_at":"2018-05-09T09:34:41.647Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","relative_url":"/knowledge-base/unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","description_was_autogenerated":false,"short_version_was_autogenerated":false},{"article_id":"qa3fhqgigq","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"Field name provided does not match an External ID.","description":"\\nYour Data Deployment with Copado is failing with the error message below:\\"Field name provided, does not match an External ID for\\"This error is most likely caused because the user who validated the o…","short_version":"\\nYour Data Deployment with Copado is failing with the error message below:\\"Field name provided, does not match an External ID for\\"This error is most likely caused because the user who validated the o…","body":"","slug":"field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-09T09:34:40.909Z","updated_at":"2018-05-09T09:34:40.909Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","relative_url":"/knowledge-base/field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","description_was_autogenerated":false,"short_version_was_autogenerated":false}]}');
            Map<String, HttpCalloutMock> calloutMap = new Map<String, HttpCalloutMock>();
            calloutMap.put('http://www.mockUrl.com', request1);
            Test.startTest();
            HttpCalloutMock multiCalloutMock = new MultiRequestMock(calloutMap);
            Test.setMock(HttpCalloutMock.class, multiCalloutMock);
            //Schedule code
            HelpDocsSyncSch scheduledClass = new HelpDocsSyncSch();
            system.schedule('SomeName', '0  00 1 3 * ?', scheduledClass);
            Test.stopTest();
        }
    }
    static testMethod void testCreate() {
        User knowledgeUser = [SELECT Id, Username FROM User where UserPermissionsKnowledgeUser=true and isActive=true limit 1];
        system.runAs(knowledgeUser){
            testHttpCalloutMock request1 = new testHttpCalloutMock(200, 'OK', '{"articles":[{"article_id":"83612pr768","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"No Snapshot records found.","description":"When trying to commit in a user story, you might see the warning below after clicking on the Commit Files button.There are 2 reason why this warning can be displayed even though you know the Git Snap…","short_version":"When trying to commit in a user story, you might see the warning below after clicking on the Commit Files button.There are 2 reason why this warning can be displayed even though you know the Git Snap…","body":"","slug":"no-snapshot-records-could-be-found-to-create-your-file-commit","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-10T10:20:03.507Z","updated_at":"2018-05-10T10:20:03.507Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/no-snapshot-records-could-be-found-to-create-your-file-commit","relative_url":"/knowledge-base/no-snapshot-records-could-be-found-to-create-your-file-commit","description_was_autogenerated":false,"short_version_was_autogenerated":false},{"article_id":"gd9qfe18h6","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"Unable to use OAuth when validating Org Credential.","description":"\\nWhen creating an Org Credential, even when valid credentials are used, sometimes Copado doesn\'t validate the OAuth athentication.This could happen i\\n\\n\\n\\nWhen creating an Org Credential, even when val…","short_version":"\\nWhen creating an Org Credential, even when valid credentials are used, sometimes Copado doesn\'t validate the OAuth athentication.This could happen i\\n\\n\\n\\nWhen creating an Org Credential, even when val…","body":"","slug":"unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-09T09:34:41.647Z","updated_at":"2018-05-09T09:34:41.647Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","relative_url":"/knowledge-base/unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","description_was_autogenerated":false,"short_version_was_autogenerated":false},{"article_id":"qa3fhqgigq","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"Field name provided does not match an External ID.","description":"\\nYour Data Deployment with Copado is failing with the error message below:\\"Field name provided, does not match an External ID for\\"This error is most likely caused because the user who validated the o…","short_version":"\\nYour Data Deployment with Copado is failing with the error message below:\\"Field name provided, does not match an External ID for\\"This error is most likely caused because the user who validated the o…","body":"","slug":"field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-09T09:34:40.909Z","updated_at":"2018-05-09T09:34:40.909Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","relative_url":"/knowledge-base/field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","description_was_autogenerated":false,"short_version_was_autogenerated":false}]}');
            Map<String, HttpCalloutMock> calloutMap = new Map<String, HttpCalloutMock>();
            calloutMap.put('http://www.mockUrl.com', request1);
            Test.startTest();
            HttpCalloutMock multiCalloutMock = new MultiRequestMock(calloutMap);
            Test.setMock(HttpCalloutMock.class, multiCalloutMock);
            List<String> kaIds = new List<String>();
            List<Knowledge__kav> KnowledgeList = new List<Knowledge__kav>([SELECT Id, Body__c, Title, HelpDocs_Id__c, KnowledgeArticleId FROM Knowledge__kav WHERE IsVisibleInPkb = true AND URLName = 'TestArticleURLName' limit 1]);
            for(Knowledge__kav this_kav : KnowledgeList) {
                kaIds.add(this_kav.Id);
            }
            system.debug(KnowledgeList);
            //Schedule code
            HelpDocsSyncSch scheduledClass = new HelpDocsSyncSch();
            //system.schedule('SomeName', '0  00 1 3 * ?', scheduledClass);
            //Execute code
            HelpDocsSyncSch.syncArticles(kaIDs);
            Test.stopTest();
        }
    }
    @IsTest static void testUpdate() {
        User knowledgeUser = [SELECT Id, Username FROM User where UserPermissionsKnowledgeUser=true and isActive=true limit 1];
        system.runAs(knowledgeUser){
            testHttpCalloutMock request1 = new testHttpCalloutMock(200, 'OK', '{"articles":[{"article_id":"83612pr768","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"No Snapshot records found.","description":"When trying to commit in a user story, you might see the warning below after clicking on the Commit Files button.There are 2 reason why this warning can be displayed even though you know the Git Snap…","short_version":"When trying to commit in a user story, you might see the warning below after clicking on the Commit Files button.There are 2 reason why this warning can be displayed even though you know the Git Snap…","body":"","slug":"no-snapshot-records-could-be-found-to-create-your-file-commit","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-10T10:20:03.507Z","updated_at":"2018-05-10T10:20:03.507Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/no-snapshot-records-could-be-found-to-create-your-file-commit","relative_url":"/knowledge-base/no-snapshot-records-could-be-found-to-create-your-file-commit","description_was_autogenerated":false,"short_version_was_autogenerated":false},{"article_id":"gd9qfe18h6","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"Unable to use OAuth when validating Org Credential.","description":"\\nWhen creating an Org Credential, even when valid credentials are used, sometimes Copado doesn\'t validate the OAuth athentication.This could happen i\\n\\n\\n\\nWhen creating an Org Credential, even when val…","short_version":"\\nWhen creating an Org Credential, even when valid credentials are used, sometimes Copado doesn\'t validate the OAuth athentication.This could happen i\\n\\n\\n\\nWhen creating an Org Credential, even when val…","body":"","slug":"unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-09T09:34:41.647Z","updated_at":"2018-05-09T09:34:41.647Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","relative_url":"/knowledge-base/unable-to-use-oauth-when-validating-org-credential-due-to-a-network-issue","description_was_autogenerated":false,"short_version_was_autogenerated":false},{"article_id":"qa3fhqgigq","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"Field name provided does not match an External ID.","description":"\\nYour Data Deployment with Copado is failing with the error message below:\\"Field name provided, does not match an External ID for\\"This error is most likely caused because the user who validated the o…","short_version":"\\nYour Data Deployment with Copado is failing with the error message below:\\"Field name provided, does not match an External ID for\\"This error is most likely caused because the user who validated the o…","body":"","slug":"field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-09T09:34:40.909Z","updated_at":"2018-05-09T09:34:40.909Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","relative_url":"/knowledge-base/field-name-provided-does-not-match-an-external-id-when-doing-data-deployments","description_was_autogenerated":false,"short_version_was_autogenerated":false}]}');
            Map<String, HttpCalloutMock> calloutMap = new Map<String, HttpCalloutMock>();
            calloutMap.put('http://www.mockUrl.com', request1);
            Test.startTest();
            HttpCalloutMock multiCalloutMock = new MultiRequestMock(calloutMap);
            Test.setMock(HttpCalloutMock.class, multiCalloutMock);
            List<String> kaIds = new List<String>();
            List<Knowledge__kav> KnowledgeList = new List<Knowledge__kav>([SELECT Id, Body__c, Title, HelpDocs_Id__c, KnowledgeArticleId FROM Knowledge__kav WHERE IsVisibleInPkb = true AND URLName = 'ArticleURLName' limit 1]);
            for(Knowledge__kav this_kav : KnowledgeList) {
                kaIds.add(this_kav.Id);
            }
            system.debug(KnowledgeList);
            //Schedule code
            //HelpDocsSyncSch scheduledClass = new HelpDocsSyncSch();
            //system.schedule('SomeName', '0  00 1 3 * ?', scheduledClass);
            //Execute code
            HelpDocsSyncSch.syncArticles(kaIDs);
            Test.stopTest();
        }
    }
    
    static testMethod void testDelete() {
        User knowledgeUser = [SELECT Id, Username FROM User where UserPermissionsKnowledgeUser=true and isActive=true limit 1];
        system.runAs(knowledgeUser){
            
            testHttpCalloutMock request1 = new testHttpCalloutMock(200, 'OK', '{"articles":[{"article_id":"83612pr768","account_id":"U8pXPShrR0","user_id":"","category_id":"79oqbheifv","author":{"name":"","profile_image":"https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=mm\\u0026s=150"},"title":"No Snapshot.","description":"When trying to commit in a user story, you might see the warning below after clicking on the Commit Files button.There are 2 reason why this warning can be displayed even though you know the Git Snap…","short_version":"When trying to commit in a user story, you might see the warning below after clicking on the Commit Files button.There are 2 reason why this warning can be displayed even though you know the Git Snap…","body":"","slug":"no-snapshot-records-could-be-found-to-create-your-file-commit","tags":[],"show_toc":false,"is_private":false,"is_published":true,"is_featured":false,"notify_of_aging":null,"history":[],"source":"","editor_type":"wysiwyg","created_at":"2018-05-10T10:20:03.507Z","updated_at":"2018-05-10T10:20:03.507Z","multilingual":[],"url":"https://docs.copa.do/knowledge-base/no-snapshot-records-could-be-found-to-create-your-file-commit","relative_url":"/knowledge-base/no-snapshot-records-could-be-found-to-create-your-file-commit","description_was_autogenerated":false,"short_version_was_autogenerated":false}]}');
            Map<String, HttpCalloutMock> calloutMap = new Map<String, HttpCalloutMock>();
            calloutMap.put('http://www.mockUrl.com', request1);
            
            //No articles in Salesforce, delete them all in HelpDocs
            Test.startTest();
            HttpCalloutMock multiCalloutMock = new MultiRequestMock(calloutMap);
            Test.setMock(HttpCalloutMock.class, multiCalloutMock);
            
            //Execute code
            HelpDocsDelSch.deleteArticles();
            Test.stopTest();
        }
    }
    
}